name: test_rel raicloud tests
on: [push]


jobs:
  Publish-Pending-Status:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/actions/github-status
        with:
          sha: ${{ github.event.inputs.sha || github.sha }}
          context: 'RAICloud Tests'
          github_token: ${{ secrets.GITHUB_TOKEN }}
          status: 'pending'
  run-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - uses: julia-actions/setup-julia@v1

      - uses: ./raicode/.github/actions/setup-raicloud
        with:
          profile: default
          environment: staging
          client_id: ${{ secrets.RAICLOUD_CLIENT_ID_STAGING }}
          client_secret: ${{ secrets.RAICLOUD_CLIENT_SECRET_STAGING }}

      - name: Build packages
        run: |
          julia --project=. -e 'using Pkg; Pkg.add("RAI"); Pkg.add("RAITest")'
      
      - name: RAITest tests
        run: |
         TEST_REL_DB_BASENAME="raitest" julia --projects=. test/runtests.jl 

  FinalizeResult:
    name: Finalize Result
    needs: 
      - Publish-Pending-Status
      - run-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
    - uses: technote-space/workflow-conclusion-action@v3
    - uses: actions/checkout@v3
    - uses: ./.github/actions/github-status
      with:
        sha: ${{ github.event.inputs.sha || github.sha }}
        context: 'RAICloud Tests'
        github_token: ${{ secrets.GITHUB_TOKEN }}
        status: ${{ env.WORKFLOW_CONCLUSION }}
